<!DOCTYPE html>
<!--
   Copyright 2014 Spotify AB
   Copyright 2016 MP Objects BV

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Online Java Thread Dump Analyzer</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js" integrity="sha256-RASNMNlmRtIreeznffYMDUxBXcMRjijEaaGF/gxT6vw=" crossorigin="anonymous"></script>
    <script src="jtdajs.js" type="text/javascript"></script>
    <script src="jtdajs.render.js" type="text/javascript"></script>
    <style type="text/css">
    :target {
      background-color: #ffa;
    }
    
    div.container-fluid:target {
      background-color: inherit;
    }
    
    ul.nav li > span.glyphicon-remove {
      display: none;
      position: absolute;
      cursor: pointer;
      right: 5px;
      top: 4px;
      color: #bbb;
    }
    
    ul.nav li:hover > span.glyphicon-remove {
      display: inline-block;
    }
    
    ul.nav li:hover > span.glyphicon-remove:hover {
      color: #d00;
    }
    
    span.thread-status-color {
      display: inline-block;
      height: 0.5em;
      width: 0.5em;
      vertical-align: middle;
    }
    
    div.thread-entry {
      margin-top: 0.5em;
    }
    
    .synchronizer-class {
      border-bottom: 1px dashed;
      cursor: help;
    }
    
    .results {
      padding-bottom: 70px;
    }
    </style>
    <script type="text/javascript">    
    var dumpCounter = 0;
    var dumpAnalysis = {};
    var analysisConfig = new jtda.AnalysisConfig();
    var renderConfig = new jtda.render.RenderConfig();
    
    function addDump() {
      ++dumpCounter;
      var model = {
        id: 'tda_'+dumpCounter,
        name: 'Dump #'+dumpCounter
      };
      dumpAnalysis[model.id] = new jtda.Analysis(model.id, analysisConfig);
      $('#adddump').parent().before(Mustache.render($('#tmpl-tab').html(), model));
      $('#dumptabs>li[data-dumpid='+model.id+']>span').click(removeDump);
      $('#dumps').append(Mustache.render($('#tmpl-tab-panel').html(), model));
      $('#dumps>div[data-dumpid='+model.id+'] form button').click(function() { executeAnalysis(model.id, $('#dumpInput_'+model.id).val()); });
      $('#dumptabs>li[data-dumpid='+model.id+']>a').tab('show');
      
      // just to make developments easier
      var saveFlag = sessionStorage.getItem('input.save.'+model.id);
      if (saveFlag == 'true') {
        $('#dumpInput_save_'+model.id).prop("checked", true);
        $('#dumpInput_'+model.id).val(sessionStorage.getItem('input.'+model.id));
      }
      $('#dumpInput_save_'+model.id).change(function() {
        var checked = $(this).prop("checked");
        sessionStorage.setItem('input.save.'+model.id, checked);
        if (!checked) {
          sessionStorage.removeItem('input.'+model.id);
        }
      });
      $('#dumpInput_'+model.id).change(function() {
        var checked = $('#dumpInput_save_'+model.id).prop("checked");
        if (checked) {
          sessionStorage.setItem('input.'+model.id, $(this).val());
        }
      });
    }
    
    function removeDump() {
      var dumpId = $(this).parent('li').attr('data-dumpid');
      var tab = $('#dumptabs>li[data-dumpid='+dumpId+']');
      if (tab.hasClass('active')) {
        if (tab.prev('li[data-dumpid]').size() > 0) {
          tab.prev('li[data-dumpid]').children('a').tab('show');
        } else {
          tab.next('li[data-dumpid]').children('a').tab('show');
        }
      }
      tab.remove();
      $('#dumps>div[data-dumpid='+dumpId+']').remove();
      delete dumpAnalysis[dumpId];
      return false;
    }
    
    function executeAnalysis(dumpId, text) {
      var analysis = dumpAnalysis[dumpId];
      analysis.analyze(text);
      console.debug(analysis);
      new jtda.render.Renderer($('#dump_'+dumpId+' div.results'), renderConfig).render(analysis);
    }
    
    $(document).ready(function(){
      $('#adddump').click(addDump);
      // create the first dump
      addDump();
    });
    </script>
  </head>
  <body>
    <div class="alert alert-info alert-dismissible">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      This page is client-side only. No data will leave your computer when you click Analyze.
    </div>

    <span id="top"></span>
    <ul id="dumptabs" class="nav nav-tabs">
      <li><a class="btn" id="adddump"><span class="glyphicon glyphicon-plus"></span></a></li>
      <li><a class="btn" href="#about" data-toggle="tab"><span class="glyphicon glyphicon-info-sign"></span></a></li>
    </ul>
    
    <div id="dumps" class="tab-content">
      <p></p>
      <div id="about" class="tab-pane container">
        <div class="jumbotron">
        <h1>Java Thread Dump Analyzer</h1>
        <p><a href="http://github.com/mpobjects/threaddump-analyzer">Source code on Github</a></p>
        </div>
        
        <div>
          <h2>License</h2>
          <p>The Java Thread Dump Analyzer is licensed under version <a href="http://www.apache.org/licenses/LICENSE-2.0.html">2.0 of the Apache license</a>.</p>
          <p>Copyright 2014 Spotify AB</p>
          <p>Copyright 2016-2017 MP Objects BV</p>
        </div>
      </div>
    </div>

    <script id="tmpl-tab" type="x-tmpl-mustache">
    <li data-dumpid="{{id}}">
      <a href="#dump_{{id}}" data-toggle="tab">{{name}}</a>
      <span class="glyphicon glyphicon-remove"></span>
    </li>
    </script>
    
    <script id="tmpl-tab-panel" type="x-tmpl-mustache">
    <div id="dump_{{id}}" class="tab-pane" data-dumpid="{{id}}">
      <div id="input_{{id}}" class="container-fluid">
        <h1>Analysis for {{name}}</h1>
        <form>
          <div class="form-group">
            <label for="dumpInput_{{id}}">Thread Dump</label>
            <!-- TODO: different input method, textarea is slow when it has a lot of content -->
            <textarea class="form-control" id="dumpInput_{{id}}" rows="5" placeholder="Paste your thread dump here"></textarea>
          </div>
          <button type="button" class="btn btn-primary">Analyze</button> <label><input type="checkbox" id="dumpInput_save_{{id}}" value="1"> Remember input</label>
        </form>
      </div>
      
      <div class="results">
      </div>
    </div>
    </script>
    
    <script id="tmpl-analysis-navbar" type="x-tmpl-mustache">
      <nav id="navbar_{{analysis_id}}" class="navbar navbar-default navbar-fixed-bottom">
        <div class="container-fluid">
          <ul class="nav navbar-nav">
            <li><a href="#top" title="Top"><span class="glyphicon glyphicon-triangle-top"></span></a></li>
            <li><a href="#input_{{analysis_id}}">Input</a></li>
            <li><a href="#running_methods_{{analysis_id}}">Running Methods <span class="label label-default"></span></a></li>
            <li><a href="#threads_{{analysis_id}}">Thread <span class="label label-default">{{analysis.threads.length}}</span></a></li>
            <li><a href="#synchronizers_{{analysis_id}}">Synchronizers <span class="label label-default">{{analysis.synchronizers.length}}</span></a></li>
            <li><a href="#garbage_{{analysis_id}}">Ignored Lines</a></li>
          </ul>
        </div>
      </nav>
    </script>
    
    <script id="tmpl-analysis-overview" type="x-tmpl-mustache">
    <div class="container-fluid">
      <h2>Overview</h2>
      <div class="row">
        <div class="col-md-2">
          <dl class="dl-horizontal">
            <dt>Threads</dt>
            <dd>{{analysis.threads.length}}</dd>
            <dt>Synchronizers</dt>
            <dd>{{analysis.synchronizers.length}}</dd>
            <dt>Deadlock status</dt>
            <dd>{{analysis.deadlockStatus}}</dd>
          </dl>
        </div>
        <div class="col-md-5">
          <canvas id="thread_status_chart_{{analysis_id}}" width="300" height="100"></canvas>
        </div>
        <div class="col-md-5">
          <canvas id="sync_type_chart_{{analysis_id}}" width="300" height="100"></canvas>
        </div>
      </div>
    </div>
    </script>
    
    <script id="tmpl-analysis-running-methods" type="x-tmpl-mustache">
    <div class="container-fluid" id="running_methods_{{analysis_id}}">
      <h2>Running Methods</h2>
      <table class="table table-striped">
      {{#methods}}
        <tr>
          <td>{{string}}</td>
          <td>
            {{#sources}}
              <a href="#thread_{{analysis_id}}_{{tid}}">{{name}}</a> <br />
            {{/sources}}
          </td>
        </tr>
      {{/methods}}
      </table>
    </div>
    </script>
    
    <script id="tmpl-analysis-thread-summary" type="x-tmpl-mustache">
      <span class="thread-status-color" style="background-color: {{threadStatusColor}}" title="{{getStatus}}"></span>
      <span class="thread-name"><a href="#thread_{{analysis_id}}_{{tid}}">{{name}}</a></span>
      <span class="thread-status">{{getStatus}}</span> 
      {{#wantNotificationOn}}
      on <span class="thread-wait-on-sync">[<a href="#sync_{{analysis_id}}_{{wantNotificationOn}}">{{wantNotificationOn}}</a>]</span>
      {{/wantNotificationOn}}
      {{#wantToAcquire}}
      <span class="thread-wait-on-sync">[<a href="#sync_{{analysis_id}}_{{wantToAcquire}}">{{wantToAcquire}}</a>]</span>
      {{/wantToAcquire}}
      {{#locksHeld.length}}
        , holding [
        {{#locksHeld}}
        <a href="#sync_{{analysis_id}}_{{.}}">{{.}}</a>
        {{/locksHeld}}
        ]
      {{/locksHeld.length}}
    </script>
    
    <script id="tmpl-analysis-threads" type="x-tmpl-mustache">
    <div class="container-fluid" id="threads_{{analysis_id}}">
      <h2>Threads</h2>
      
      {{#threads}}
      <div class="thread-entry">
        <div id="thread_{{analysis_id}}_{{tid}}" class="thread-header">
          {{> thread-summary}}
        </div>
        <div class="row thread-stack">
          <div class="col-md-offset-1 thread-stack">        
            {{#frames}}
              <samp>{{.}}</samp><br />
            {{/frames}}
          </div>
        </div>
      </div>
      {{/threads}}
    </div>
    </script>
    
    <script id="tmpl-analysis-synchronizers" type="x-tmpl-mustache">
    <div class="container-fluid" id="synchronizers_{{analysis_id}}">
      <h2>Synchronizers</h2>
      <table class="table table-striped">
      {{#synchronizers}}
      <tr class="synchronizer-entry">
        <td id="sync_{{analysis_id}}_{{id}}">
          <span class="synchronizer-id">{{id}}</span> <br />
          <span class="synchronizer-class" title="{{className}}"><samp>{{prettyClassName}}</code></samp> <br />
          
          {{#deadlockStatus.severity}}
          {{#deadlockStatus}}
          <span class="label label-{{notificationLevel}} synchronizer-deadlock">{{.}}</span>
          {{/deadlockStatus}}
          {{/deadlockStatus.severity}}          
        </td>
        <td>
          {{#lockHolder}}
            Held by<br />           
            {{> thread-summary}}
            <br />
          {{/lockHolder}}
          
          {{#notificationWaiters.length}}
            <span>{{notificationWaiters.length}} thread(s) waiting for notifcation:</span><br />
            {{#notificationWaiters}}
              <span class="thread-status-color" style="background-color: {{threadStatusColor}}" title="{{getStatus}}"></span>
              <a href="#thread_{{analysis_id}}_{{tid}}">{{name}}</a> <br />
            {{/notificationWaiters}}
          {{/notificationWaiters.length}}
        
          {{#lockWaiters.length}}
            <span>{{lockWaiters.length}} thread{s} waiting to take lock</span> <br />
            {{#lockWaiters}}
              <span class="thread-status-color" style="background-color: {{threadStatusColor}}" title="{{getStatus}}"></span>
              <a href="#thread_{{analysis_id}}_{{tid}}">{{name}}</a> <br />
            {{/lockWaiters}}
          {{/lockWaiters.length}}
        </td>
      </tr>
      {{/synchronizers}}
      </table>
    </div>
    </script>
    
    <script id="tmpl-analysis-garbage" type="x-tmpl-mustache">
    <div class="container-fluid" id="garbage_{{analysis_id}}">
      <h2>Ignored Lines</h2>
    </div>
    </script>

  </body>
</html>
