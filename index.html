<!DOCTYPE html>
<!--
   Copyright 2014 Spotify AB
   Copyright 2016 MP Objects BV

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<html lang="en">
  <head>
    <title>Online Java Thread Dump Analyzer</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js" integrity="sha256-RASNMNlmRtIreeznffYMDUxBXcMRjijEaaGF/gxT6vw=" crossorigin="anonymous"></script>
    <script src="jtdajs.js" type="text/javascript"></script>
    <style type="text/css">
    ul.nav li > span.glyphicon-remove {
      display: none;
      position: absolute;
      cursor: pointer;
      right: 5px;
      top: 4px;
      color: #bbb;
    }
    
    ul.nav li:hover > span.glyphicon-remove {
      display: inline-block;
    }
    
    ul.nav li:hover > span.glyphicon-remove:hover {
      color: #d00;
    }
    </style>
    <script type="text/javascript">
    var chartcolors = [ '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
    
    var dumpCounter = 0;
    var dumpAnalysis = {};
    var analysisConfig = new jtda.AnalysisConfig();
    
    function addDump() {
      ++dumpCounter;
      var model = {
        id: 'tda_'+dumpCounter,
        name: 'Dump #'+dumpCounter
      };
      dumpAnalysis[model.id] = new jtda.Analysis(model.id, analysisConfig);
      $('#adddump').parent().before(Mustache.render($('#tmpl-tab').html(), model));
      $('#dumptabs>li[data-dumpid='+model.id+']>span').click(removeDump);
      $('#dumps').append(Mustache.render($('#tmpl-tab-panel').html(), model));
      $('#dumps>div[data-dumpid='+model.id+'] form button').click(function() { executeAnalysis(model.id, $('#dumpInput_'+model.id).val()); });
      $('#dumptabs>li[data-dumpid='+model.id+']>a').tab('show');
    }
    
    function removeDump() {
      var dumpId = $(this).parent('li').attr('data-dumpid');
      var tab = $('#dumptabs>li[data-dumpid='+dumpId+']');
      if (tab.hasClass('active')) {
        if (tab.prev('li[data-dumpid]').size() > 0) {
          tab.prev('li[data-dumpid]').children('a').tab('show');
        } else {
          tab.next('li[data-dumpid]').children('a').tab('show');
        }
      }
      tab.remove();
      $('#dumps>div[data-dumpid='+dumpId+']').remove();
      delete dumpAnalysis[dumpId];
      return false;
    }
    
    function executeAnalysis(dumpId, text) {
      var analysis = dumpAnalysis[dumpId];
      analysis.analyze(text);
      console.debug(analysis);
      renderDump(analysis);
    }
    
    function renderDump(analysis) {
      var dumpId = analysis.id;
      var resultElm = $('#dump_'+dumpId+' div.results').empty();
      
      resultElm.append(Mustache.render($('#tmpl-analysis-overview').html(), analysis));
      new Chart('thread_status_chart_'+dumpId, {
        type: 'doughnut',
        data: getThreadStatusChartData(analysis),
        options: {
          responsive: true,
          maintainAspectRatio: true,
          title: {
            display: true,
            position: "left",
            text: "Thread Status"
          },
          legend: {
            position: "right"
          }
        }
      });
    };
    
    function getThreadStatusChartData(analysis) {
      var counts = {};
      var labels = [];
      for (var i = 0; i < analysis.threads.length; ++i) {
        var status = analysis.threads[i].getStatus().status;
        if (counts[status]) {
          ++counts[status];
        }
        else {
          counts[status] = 1;
          labels.push(status);
        }
      }
      var dataset = { data: [], backgroundColor: chartcolors };
      for (var i = 0; i < labels.length; ++i) {
        dataset.data.push(counts[labels[i]]);
      }
      var res = { labels: labels, datasets: [dataset] };
      console.log(res);
      return res;
    }
    
    $(document).ready(function(){
      $('#adddump').click(addDump);
      // create the first dump
      addDump();
    });
    </script>
  </head>
  <body>
    <div class="alert alert-info alert-dismissible">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      This page is client-side only. No data will leave your computer when you click Analyze.
    </div>

    <ul id="dumptabs" class="nav nav-tabs">
      <li><a class="btn" id="adddump"><span class="glyphicon glyphicon-plus"></span></a></li>
      <li><a class="btn" href="#about" data-toggle="tab"><span class="glyphicon glyphicon-info-sign"></span></a></li>
    </ul>
    
    <div id="dumps" class="tab-content">
      <p></p>
      <div id="about" class="tab-pane container">
        <div class="jumbotron">
        <h1>Java Thread Dump Analyzer</h1>
        <p><a href="http://github.com/mpobjects/threaddump-analyzer">Source code on Github</a></p>
        </div>
        
        <div>
          <h2>License</h2>
          <p>The Java Thread Dump Analyzer is licensed under version <a href="http://www.apache.org/licenses/LICENSE-2.0.html">2.0 of the Apache license</a>.</p>
          <p>Copyright 2014 Spotify AB</p>
          <p>Copyright 2016 MP Objects BV</p>
        </div>
      </div>
    </div>

    <script id="tmpl-tab" type="x-tmpl-mustache">
    <li data-dumpid="{{id}}">
      <a href="#dump_{{id}}" data-toggle="tab">{{name}}</a>
      <span class="glyphicon glyphicon-remove"></span>
    </li>
    </script>
    
    <script id="tmpl-tab-panel" type="x-tmpl-mustache">
    <div id="dump_{{id}}" class="tab-pane" data-dumpid="{{id}}">
      <div id="input_{{id}}" class="container-fluid">
        <h1>Analysis for {{name}}</h1>
        <form>
          <div class="form-group">
            <label for="dumpInput_{{id}}">Thread Dump</label>
            <!-- TODO: different input method, textarea is slow when it has a lot of content -->
            <textarea class="form-control" id="dumpInput_{{id}}" rows="5" placeholder="Paste your thread dump here"></textarea>
          </div>
          <button type="button" class="btn btn-primary">Analyze</button>
        </form>
      </div>
      
      <div class="results" class="container-fluid">
      </div>
      
      <nav id="navbar_{{id}}" class="navbar navbar-default navbar-fixed-bottom">
        <div class="container-fluid">
          <ul class="nav navbar-nav">
            <li id="nav_input_{{id}}"><a href="#input_{{id}}">Input</a></li>
            <li id="nav_methods_{{id}}"><a href="#methods_{{id}}">Top Running Methods <span class="label label-default"></span></a></li>
            <li id="nav_threads_{{id}}"><a href="#threads_{{id}}">Thread Overview <span class="label label-default"></span></a></li>
            <li id="nav_synchronizers_{{id}}"><a href="#synchronizers_{{id}}">Synchronizers <span class="label label-default"></span></a></li>
            <li id="nav_garbage_{{id}}"><a href="#garbage_{{id}}">Ignored Lines</a></li>
          </ul>
        </div>
      </nav>
    </div>
    </script>
    
    <script id="tmpl-analysis-overview" type="x-tmpl-mustache">
    <div class="container-fluid">
      <h2>Overview</h2>
      <div class="row">
        <div class="col-md-4">
          <dl class="dl-horizontal">
            <dt>Threads</dt>
            <dd>{{threads.length}}</dd>
            <dt>Synchronizers</dt>
            <dd>{{synchronizers.length}}</dd>
          </dl>
        </div>
        <div class="col-md-4">
          <canvas id="thread_status_chart_{{id}}" width="300" height="100"></canvas>
        </div>
      </div>
    </div>
    </script>

  </body>
</html>
